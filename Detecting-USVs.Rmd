---
title: <center><font size="6"><b>Detecting USVs</b></font></center>
subtitle: <center><font size="4"><b>Rat ultrasonic vocalizations</b></font></center>
author: <center><font size="4"><a href="http://marceloarayasalas.weebly.com/">Marcelo Araya-Salas, PhD</a></font></center>
date: <center>`r format(Sys.Date(), "%d-%m-%Y")`</center>
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3
    df_print: kable
    toc_float:
      collapsed: yes
      smooth_scroll: yes
fontsize: 12pt 
editor_options: 
  chunk_output_type: console
---

```{r packages, message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE, include = FALSE}

## add 'developer/' to packages to be installed from github
x <- c("devtools", "maRce10/warbleR", "bioacoustics", "pbapply", "Rraven", "parallel", "viridis", "rfigshare", "svMisc", "readxl", "ranger", "kableExtra", "DT", "maRce10/ohun")

aa <- lapply(x, function(y) {
  
  # get pakage name
  pkg <- strsplit(y, "/")[[1]]
  pkg <- pkg[length(pkg)]
  
  # check if installed, if not then install 
  if (!pkg %in% installed.packages()[,"Package"])  {

      if (grepl("/", y))  devtools::install_github(y, force = TRUE) else
    install.packages(y) 
    }

  # load package
  try(require(pkg, character.only = T), silent = T)
})

```

```{r functions and global parameters, eval = TRUE, echo = FALSE}

warbleR_options(
  wav.path = "~/Dropbox/Recordings/ratas_cin/full_recs/converted_sound_files/cuts/"
)

opts_knit$set(root.dir = "..")

```

```{r read manual selections, eval = FALSE}

mnl_sls <- imp_raven(path = "./data/raw/no_bedding_annotations", warbler.format = TRUE, all.data = TRUE, name.from.file = TRUE, ext.case = "upper", unread = TRUE)

unread_l <- lapply(file.path("./data/raw/no_bedding_annotations/", mnl_sls$unread_files), function(x) {
  X <- read.table(x, sep = ",", header = TRUE)
  X$selec.file <- X$sound.files <- basename(x)
  return(X)
  })

# remove 4 and 5 as those have only 1 selection and no frequency info
unread_l <- unread_l[1:3]

unread <- do.call(rbind, unread_l)
unread$type <- unread$subtype <- NA

unread <- relabel_colms(unread, hz.to.khz = TRUE)
unread <- sort_colms(unread)

head(unread)

mnl_sls <- sort_colms(mnl_sls$selections)

names(mnl_sls)
names(unread)
mnl_sls$`Begin File` <- NULL

mnl_sls <- rbind(mnl_sls, unread)

mnl_sls$sound.files <- gsub("A_AMPH_15-45_estres_parte2_AUDIO |A_AMPH_15-45_estres_parte2_Audio |A_AMPH_15-45_estres_parte2_AUDIO_", "", mnl_sls$sound.files)

mnl_sls$sound.files <- gsub("T000003.WAV", "T0000003.WAV", mnl_sls$sound.files)
mnl_sls$sound.files <- gsub("T000009.WAV", "T0000009.WAV", mnl_sls$sound.files)
mnl_sls$sound.files <- gsub("T000011.WAV", "T0000011.WAV", mnl_sls$sound.files)
mnl_sls$sound.files <- gsub("T000012.WAV", "T0000012.WAV", mnl_sls$sound.files)
mnl_sls$sound.files <- gsub("T000013.WAV", "T0000013.WAV", mnl_sls$sound.files)
mnl_sls$sound.files <- gsub("T000014.WAV", "T0000014.WAV", mnl_sls$sound.files)

mnl_sls$sound.files <- gsub(".txt$", ".WAV", mnl_sls$sound.files)

unique(mnl_sls$sound.files)

mnl_sls$selec <- 1:nrow(mnl_sls)

cs <- check_sels(mnl_sls)

# unique(cs$sound.files[grep("sound file not found", cs$check.res)])

# table(cs$check.res)

mnl_sls <- mnl_sls[cs$check.res == "OK", ]

cs <- check_sels(mnl_sls)


mnl_sls$bottom.freq[mnl_sls$selec == 2474] <- 48.9885
mnl_sls$top.freq[mnl_sls$selec == 2474] <- 73.8728
mnl_sls$bottom.freq[mnl_sls$selec == 2198] <- 59.6217
mnl_sls$top.freq[mnl_sls$selec == 2198] <- 74311.4
mnl_sls$top.freq[mnl_sls$selec == 1852] <- 111473.9

mnl_sls$top.freq[mnl_sls$top.freq > 100] <- 98

mnl_sls <- mnl_sls[mnl_sls$bottom.freq > 20,]

# export raven file to double check
# exp_raven(mnl_sls, path = "./data/processed", file.name = "pooled_manual_annotations", sound.file.path = .Options$warbleR$path)


```

```{r, import annotations fix and split sound files, eval = FALSE}

# fix_path(path = "./data/processed/", sound.file.col = "Begin File", new.begin.path = "/home/m/Dropbox/Recordings/ratas_cin/full_recs/converted_sound_files")

manual_annot <- imp_raven("./data/processed/", warbler.format = TRUE, files = "fixed_pooled_manual_annotations_JE.txt")

cs <- check_sels(manual_annot)

wav_info()

# fix_wavs(samp.rate = 200, bit.depth = 16)

# split in 5 min segments
split_sels <- split_sound_files(sgmt.dur = 5 * 60, only.sels = FALSE, X = manual_annot, parallel = 4)

cs <- check_sels(split_sels, parallel = 10)

split_sels <- split_sels[cs$check.res == "OK", ]

sp <- spectro_analysis(split_sels, wl = 512, parallel = 10)

split_sels$peak.freq <- sp$meanpeakf
split_sels$duration <- split_sels$end - split_sels$start


split_sels <- sig2noise(split_sels, mar = 0.005, parallel = 10)

write.csv(split_sels, "./data/processed/split_manual_annotations_5min_no_bedding.csv", row.names = FALSE)

# export raven file to double check
exp_raven(split_sels, path = "./data/processed", file.name = "split_manual_annotations_5min", sound.file.path = .Options$warbleR$path)

```

```{r calculate envelopes, eval = FALSE}

split_sels <- read.csv("./data/processed/split_manual_annotations_5min_no_bedding.csv")

fls <- list.files(.Options$warbleR$path)

out <- pbsapply(fls, cl = 2, function(i){
  envs <- try(envs <- autodetec(output = "list", pb = FALSE, para = 1, flist = i), silent = TRUE)

  if (!is(envs, "try-error")) {
  saveRDS(envs, paste0("./data/processed/autodetec_rds_files/envelopes_from_autodetec_", i,".RDS"))

      return("OK")} else
        return("didn't work")
})



```

```{r optimize detection for 22 kHz test cut, eval = FALSE}
# wv <- read_wave("T0000011-1.wav", path = "/home/m/Dropbox/Recordings/ratas_cin/full_recs/converted_sound_files/cuts")
# 
# wv <- cutw(wv, from = 0, to = 99, output = "Wave")
# 

# wv <- normalize(wv, unit = "16")
# writeWave(wv, filename = "./data/processed/test_sound_files/test_22kHz.wav", extensible = FALSE)

split_sels <- read.csv("./data/processed/split_manual_annotations_5min_no_bedding.csv")

sels_22 <- split_sels[split_sels$sound.files == "T0000011-1.wav" & split_sels$end < 99, ]

#change sound file name
sels_22$sound.files <- "test_22kHz.wav"

min(gaps(sels_22)$gaps, na.rm = TRUE)

# spectrograms of with manual annotations
full_spectrograms(sels_22, flim = c(20, 30), rows = 20, dest.path = "./data/processed/test_sound_files", path = "./data/processed/test_sound_files", suffix = "test_manual_annotations", width = 15, height = 8.5, fast.spec = TRUE)

# detection on test cut
env <- autodetec(output = "list", pb = FALSE, para = 1, flist = unique(sels_22$sound.files), mindur = 0.001, threshold = 6, path = "./data/processed/test_sound_files", ssmooth = 4000, hold.time = 0.07, bp = c(20, 30))

diagnose_detection(sels_22, env$selection.table)

# plot spectros and envelopes
full_spectrograms(env, flim = c(20, 30), rows = 5, dest.path = "./data/processed/test_sound_files", path = "./data/processed/test_sound_files", suffix = "test_autodetec", width = 15, height = 8.5, fast.spec = TRUE)


optim_ad <- optimize_auto_detec(X = sels_22, Y = env, threshold = seq(1, 10, 1), wl = 512, power = c(1, 1.2), bp = c(20, 30), mindur = 0.001, ssmooth = c(400, 6000, 8000), hold.time = seq(0.05, 0.09, 0.01), path = "./data/processed/test_sound_files")

View(optim_ad[optim_ad$sensitivity == 1 & optim_ad$specificity == 1 & optim_ad$split.positives == 0, ])

saveRDS(optim_ad, "./data/processed/optimization_on_test_22kHz.RDS")


full_spectrograms(env, flim = c(20, 30), rows = 5, dest.path = "./data/processed/test_sound_files", path = "./data/processed/test_sound_files", suffix = "test_autodetec", width = 15, height = 8.5, fast.spec = TRUE)



# check selected parameters
env2 <- autodetec(output = "list", pb = FALSE, para = 1, flist = unique(sels_22$sound.files), mindur = 0.001, threshold = 2, path = "./data/processed/test_sound_files", ssmooth = 4000, hold.time = 0.06, bp = c(20, 30))

diagnose_detection(sels_22, env2$selection.table)

# plot spectros and envelopes
full_spectrograms(env2, flim = c(20, 30), rows = 5, dest.path = "./data/processed/test_sound_files", path = "./data/processed/test_sound_files", suffix = "test_autodetec_best_parameters", width = 15, height = 8.5, fast.spec = TRUE)


```

# Optimize detection for 22 kHz single cut with more signals

```{r optimize detection for 22 kHz single 5 min cut, eval = FALSE}

split_sels <- read.csv("./data/processed/split_manual_annotations_5min_no_bedding.csv")

sels_22 <- split_sels[split_sels$sound.files == "T0000011-1.wav", ]


oed <- optimize_energy_detector(reference = sels_22, threshold = seq(0.015, 0.025, 0.005), min.duration = seq(0.001, 0.003, 0.001), ssmooth = c(5, 10, 15), hold.time = seq(0.08, 0.1, 0.01), path = .Options$warbleR$path, thinning = c(0.5, 1), parallel = 15,  bp = c(20, 30), max.duration = 3)

# full_spectrograms(env, flim = c(20, 30), rows = 5, dest.path = "./data/processed/test_sound_files", suffix = "test_autodetec_best_parameters", width = 15, height = 8.5, fast.spec = TRUE)

# View(optim_ad[optim_ad$sensitivity == 1 & optim_ad$specificity == 1, ])

saveRDS(oed, "./data/processed/optimization_22kHz.RDS")


# test best 
# ed <- energy_detector(files =  unique(sels_22$sound.files), threshold = 0.015, min.duration = 0.002, ssmooth = 15, hold.time = 0.1, path = .Options$warbleR$path, thinning = 0.5, parallel = 12, bp = c(20, 30))
# 
# diagnose_detection(sels_22, ed, parallel = 12)
# test best 
# env_best <- autodetec(output = "list", pb = FALSE, para = 1, flist = unique(sels_22$sound.files), mindur = 0.001, threshold = 2, ssmooth = 6000, hold.time = 0.09, bp = c(20, 30), power = 1)
# 
# diagnose_detection(sels_22, env_best$selection.table)
# 
# env_best2 <- autodetec(output = "list", X = env, pb = FALSE, para = 1, flist = unique(sels_22$sound.files), mindur = 0.001, threshold = 2, ssmooth = 6000, hold.time = 0.09, bp = c(20, 30), power = 1)
# 
# diagnose_detection(sels_22, env_best2$selection.table)

```

```{r results optimize detection for 22 kHz single 5 min cut, eval = TRUE}

optim_ad <- readRDS("./data/processed/optimization_22kHz.RDS")

# print dynamic table
oa_DT <- datatable(optim_ad, editable = list(
  target = 'row'
), rownames = FALSE, style = "bootstrap",  filter = 'top', options = list(
  pageLength = 100, autoWidth = TRUE, dom = 'ft'
), autoHideNavigation = TRUE, escape = FALSE)

formatRound(table = oa_DT, columns = sapply(optim_ad, is.numeric), 3)

```

# Optimize detection for 22 kHz 4 cuts with more signals

```{r optimize detection for 22 kHz 4 cuts, eval = FALSE}

split_sels <- read.csv("./data/processed/split_manual_annotations_5min_no_bedding.csv")

sels_22 <- split_sels[split_sels$peak.freq > 20 & split_sels$peak.freq < 30, ]

tab <- table(sels_22$sound.files)
sels_22 <- sels_22[sels_22$sound.files %in% names(tab)[tab > 20], ]

# best tuning parameters 
oed4 <- optimize_energy_detector(reference = sels_22, files =  unique(sels_22$sound.files), threshold = 0.02, min.duration = 0.002, ssmooth = c(13, 15, 17), hold.time = c(0.05, 0.08, 0.09, 0.1), path = .Options$warbleR$path, thinning = 0.5, parallel = 10, bp = c(20, 30), max.duration = c(3, 2.5, 5, 10, 10000), by.sound.file = TRUE, previous.output = oed4)

saveRDS(oed4, "./data/processed/optimization_22kHz_4_cuts.RDS")

```

```{r results optimize detection for 22 kHz 4 cuts, eval = TRUE}

optim_ad <- readRDS("./data/processed/optimization_22kHz_4_cuts.RDS")

# optim_ad <- optim_ad[optim_ad$sound.files == "T0000011-1.wav", ]
optim_ad <- summarize_diagnostic(optim_ad,time.diagnostics = TRUE)

oa_DT <- datatable(optim_ad, editable = list(
  target = 'row'
), rownames = FALSE, style = "bootstrap",  filter = 'top', options = list(
  pageLength = 100, autoWidth = TRUE, dom = 'ft'
), autoHideNavigation = TRUE, escape = FALSE)

formatRound(table = oa_DT, columns = sapply(optim_ad, is.numeric), 3)
 
```

# Optimal detection diagnostic 22 kHz 4 cuts

```{r optimize detection for 22 kHz 4 cuts try selected tuning parameters, eval = FALSE}

split_sels <- read.csv("./data/processed/split_manual_annotations_5min_no_bedding.csv")

sels_22 <- split_sels[split_sels$peak.freq > 20 & split_sels$peak.freq < 30, ]

tab <- table(sels_22$sound.files)
sels_22 <- sels_22[sels_22$sound.files %in% names(tab)[tab > 20], ]
# summary(sels_22$peak.freq)
length(unique(sels_22$sound.files))

# best tuning parameters 
ed4 <- energy_detector(files =  unique(sels_22$sound.files), threshold = 0.02, min.duration = 0.002, ssmooth = 17, hold.time = 0.025, path = .Options$warbleR$path, thinning = 0.5, parallel = 8, bp = c(20, 30), max.duration = 3)

led4 <- label_detection(reference = sels_22, detection = ed4, parallel = 10)

ed4$detection.class <- led4$detection.class
ed4$reference.row <- led4$reference.row
ed4$overlap <- led4$overlap

fed4 <- filter_detection(ed4, parallel = 10)

saveRDS(fed4, "./data/processed/optimal_detection_22kHz_4_cuts.RDS")

```

## By sound file

```{r optimize detection for 22 kHz 4 cuts try selected tuning parameters results by sound file, eval = TRUE}
ed4 <- readRDS("./data/processed/optimal_detection_22kHz_4_cuts.RDS")

split_sels <- read.csv("./data/processed/split_manual_annotations_5min_no_bedding.csv")

sels_22 <- split_sels[split_sels$peak.freq > 20 & split_sels$peak.freq < 30, ]

tab <- table(sels_22$sound.files)
sels_22 <- sels_22[sels_22$sound.files %in% names(tab)[tab > 20], ]


optim_ad_bs <- diagnose_detection(reference = sels_22, detection = ed4, by.sound.file = TRUE)

oa_DT <- datatable(optim_ad_bs, editable = list(
  target = 'row'
), rownames = FALSE, style = "bootstrap",  filter = 'top', options = list(
  pageLength = 100, autoWidth = TRUE, dom = 'ft'
), autoHideNavigation = TRUE, escape = FALSE)

formatRound(table = oa_DT, columns = sapply(optim_ad_bs, is.numeric), 3)

```

## Summarized

```{r optimize detection for 22 kHz 4 cuts try selected tuning parameters results, eval = TRUE}

optim_ad <- diagnose_detection(reference = sels_22, detection = ed4)

oa_DT <- datatable(optim_ad, editable = list(
  target = 'row'
), rownames = FALSE, style = "bootstrap",  filter = 'top', options = list(
  pageLength = 100, autoWidth = TRUE, dom = 'ft'
), autoHideNavigation = TRUE, escape = FALSE)

formatRound(table = oa_DT, columns = sapply(optim_ad, is.numeric), 3)

  
```

# Detection over all files

```{r Run detection over all files, eval=FALSE}

split_sels <- read.csv("./data/processed/split_manual_annotations_5min_no_bedding.csv")

# best tuning parameters 
ed_all <- energy_detector(files =  unique(split_sels$sound.files), threshold = 0.02, min.duration = 0.002, ssmooth = 17, hold.time = 0.025, path = .Options$warbleR$path, thinning = 0.5, parallel = 4, bp = c(20, 30), max.duration = 3)

sels_22 <- split_sels[split_sels$peak.freq > 20 & split_sels$peak.freq < 30, ]

label_ed_all <- label_detection(reference = sels_22, detection = ed_all, parallel = 10)
filter_ed_all <- filter_detection(label_ed_all, parallel = 10)

saveRDS(filter_ed_all, "./data/processed/optimal_detection_22kHz_all_cuts.RDS")

```

## By sound file

```{r optimize detection all 22 kHz cuts try selected tuning parameters results by sound file, eval = TRUE}

ed_all <- readRDS("./data/processed/optimal_detection_22kHz_all_cuts.RDS")

split_sels <- read.csv("./data/processed/split_manual_annotations_5min_no_bedding.csv")

sels_22 <- split_sels[split_sels$peak.freq > 20 & split_sels$peak.freq < 30, ]

optim_ad_bs_all <- diagnose_detection(reference = sels_22, detection = ed_all, by.sound.file = TRUE, pb = FALSE)

oa_DT <- datatable(optim_ad_bs_all, editable = list(
  target = 'row'
), rownames = FALSE, style = "bootstrap",  filter = 'top', options = list(
  pageLength = 100, autoWidth = TRUE, dom = 'ft'
), autoHideNavigation = TRUE, escape = FALSE)

formatRound(table = oa_DT, columns = sapply(optim_ad_bs, is.numeric), 3)

```

## Summarized

```{r optimize detection for all 22 kHz cuts try selected tuning parameters results, eval = TRUE}

optim_ad_all <- diagnose_detection(reference = sels_22, detection = ed_all, pb = FALSE)

oa_DT <- datatable(optim_ad_all, editable = list(
  target = 'row'
), rownames = FALSE, style = "bootstrap",  filter = 'top', options = list(
  pageLength = 100, autoWidth = TRUE, dom = 'ft'
), autoHideNavigation = TRUE, escape = FALSE)

formatRound(table = oa_DT, columns = sapply(optim_ad, is.numeric), 3)

  
```

## Random forest results
```{r measure acoustic parameters and run random forest 0.38, eval = FALSE}

lab_detec <- readRDS("./data/processed/optimal_detection_22kHz_all_cuts.RDS")

# measure spectrographic parameters
spectral_parameters <- spectro_analysis(lab_detec, bp = c(1, 3.5), fast = TRUE, ovlp = 70, parallel = 10)

mfccs <- mfcc_stats(X = lab_detec, bp = c(1, 3.5), ovlp = 70, parallel = 10)

na_rows <- unique(unlist(sapply(mfccs, function(x) which(is.na(x)))))

lab_detec <- lab_detec[-na_rows, ]
spectral_parameters <- spectral_parameters[-na_rows, ]
mfccs <- mfccs[-na_rows, ]

spectral_parameters$class <- lab_detec$detection.class

spectral_parameters <- data.frame(spectral_parameters, mfccs[, !names(spectral_parameters) %in% c("sound.files", "selec")])

spectral_parameters$class[spectral_parameters$class != "false.positive"] <- "true.positive"

# make it a factor for ranger to work 
spectral_parameters$class <- as.factor(spectral_parameters$class)
  
  # run RF model spectral and cepstral parameters
  rfm <-
    ranger(
      class ~ .,
      data = spectral_parameters[, !names(spectral_parameters) %in% c("sound.files", "selec")],
      num.trees = 10000,
      importance = "impurity",
      seed = 10
    )
  
saveRDS(list(rfm = rfm, spectral_parameters = spectral_parameters, lab_detec_0.38 = lab_detec), "./data/processed/data_and_model_random_forest_0.38_threshold.RDS")  
```

```{r random forest results 0.38, eval = FALSE}
attach(readRDS("./data/processed/data_and_model_random_forest_0.38_threshold.RDS")  )

rfm
```

Diagnostic after random forest classification:
```{r random forest diagnostic 0.38, eval = FALSE}
lab_detec <- lab_detec_0.38
# table(lab_detec$detection.class)
lab_detec$pred.class <- rfm$predictions

positive_detec <- lab_detec[lab_detec$pred.class == "true.positive", ]


temp_detec <- positive_detec
temp_detec$detection.class <- "true.positive"

diag <- diagnose_detection(reference = sls, detection = temp_detec, pb = FALSE)

# print dynamic table
oa_DT <- datatable(diag, editable = list(
  target = 'row'
), rownames = FALSE, style = "bootstrap",  filter = 'top', options = list(
  pageLength = 100, autoWidth = TRUE, dom = 'ft'
), autoHideNavigation = TRUE, escape = FALSE)

formatRound(table = oa_DT, columns = sapply(diag, is.numeric), 3)
```

 Black line = 1:1
 gray line = model slope
```{r random forest results plots 0.38, eval = FALSE}

obs_count <- tapply(sls$sound.files, sls$sound.files, length)
pred_count <- tapply(positive_detec$sound.files, positive_detec$sound.files, length)

int_columns <- intersect(names(obs_count), names(pred_count))
obs_count <- obs_count[names(obs_count) %in% int_columns]
pred_count <- pred_count[names(pred_count) %in% int_columns]
pred_count <- pred_count[order(names(pred_count))]
obs_count <- obs_count[order(names(obs_count))]

df <- data.frame(sound.files = names(obs_count), observed = obs_count, predicted = pred_count)

ggplot(df, aes(x = observed, y = predicted)) +
  geom_point(color = viridis(10, alpha = 0.4)[2], size = 3) +
  geom_abline(slope = 1, intercept = 0) +
  annotate("text", x = 50, y = 150, label = paste("r =", round(cor(obs_count, pred_count), 3)), size = 8) + 
  geom_smooth(method = "lm", se = FALSE, col = "gray") +
  theme_classic(base_size = 20)

(lm(pred_count ~ obs_count))

```

Removing outlier
```{r random forest results plots 2 0.38, eval = FALSE}
ggplot(df[df$observed < 100, ], aes(x = observed, y = predicted)) +
  geom_point(color = viridis(10, alpha = 0.4)[2], size = 3) +
  geom_abline(slope = 1, intercept = 0) +
  annotate("text", x = 50, y = 150, label = paste("r =", round(cor(obs_count[obs_count < 100], pred_count[obs_count < 100]), 3)), size = 8) + 
  geom_smooth(method = "lm", se = FALSE, col = "gray") +
  theme_classic(base_size = 20)


(lm(pred_count[obs_count < 100] ~ obs_count[obs_count < 100]))

```

---

<font size="4">Session information</font>

```{r session info, echo=F, eval = TRUE}

sessionInfo()

```
